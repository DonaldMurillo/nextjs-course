# Chapter 10.1: Image Optimization

## Overview

Images often account for the largest portion of page weight. Next.js provides the `next/image` component that automatically optimizes images for better performance and Core Web Vitals.

## The Image Component

```tsx
import Image from 'next/image';

export function Hero() {
  return (
    <Image
      src="/hero.jpg"
      alt="Hero image"
      width={1200}
      height={600}
    />
  );
}
```

## What It Does Automatically

1. **Format Conversion**: Serves WebP or AVIF when browser supports it
2. **Responsive Sizing**: Generates multiple sizes for different devices
3. **Lazy Loading**: Only loads images when they enter viewport
4. **Blur Placeholder**: Shows blur while image loads
5. **Prevents Layout Shift**: Reserves space before image loads

## Required Props

### Local Images

```tsx
import Image from 'next/image';
import heroImage from '@/public/hero.jpg';

// Option 1: Import (recommended - enables blur placeholder)
<Image src={heroImage} alt="Hero" />

// Option 2: Path string (requires width/height)
<Image src="/hero.jpg" alt="Hero" width={1200} height={600} />
```

### Remote Images

Remote images always require width and height:

```tsx
<Image
  src="https://example.com/photo.jpg"
  alt="Photo"
  width={800}
  height={600}
/>
```

Configure allowed domains in `next.config.ts`:

```ts
// next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
      },
      {
        protocol: 'https',
        hostname: '**.cloudinary.com',
      },
      {
        protocol: 'https',
        hostname: 'avatars.githubusercontent.com',
      },
    ],
  },
};

export default nextConfig;
```

## Sizing Strategies

### Fixed Size

For images with known dimensions:

```tsx
<Image src="/logo.png" alt="Logo" width={200} height={50} />
```

### Fill Container

For responsive images that fill their container:

```tsx
<div className="relative h-64 w-full">
  <Image
    src="/hero.jpg"
    alt="Hero"
    fill
    className="object-cover"
  />
</div>
```

**Important:** Parent must have `position: relative` and defined dimensions.

### Responsive with Sizes

Tell the browser how large the image will be at different viewports:

```tsx
<Image
  src="/hero.jpg"
  alt="Hero"
  fill
  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
/>
```

This generates optimal `srcset` values and helps browsers pick the right size.

## Priority Loading

Use `priority` for images visible immediately (above the fold), especially LCP images:

```tsx
<Image
  src="/hero.jpg"
  alt="Hero"
  width={1200}
  height={600}
  priority  // Preloads this image
/>
```

Only use `priority` for 1-2 images per page - typically the hero image.

## Placeholder Options

### Blur Placeholder (Local Images)

Automatically generated for imported images:

```tsx
import heroImage from '@/public/hero.jpg';

<Image
  src={heroImage}
  alt="Hero"
  placeholder="blur"  // Uses auto-generated blur
/>
```

### Blur Placeholder (Remote Images)

Provide a base64 data URL:

```tsx
<Image
  src="https://example.com/photo.jpg"
  alt="Photo"
  width={800}
  height={600}
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRg..."
/>
```

Generate blur data URLs with tools like [plaiceholder](https://plaiceholder.co/) or during build time.

### Empty Placeholder

```tsx
<Image
  src="/photo.jpg"
  alt="Photo"
  width={800}
  height={600}
  placeholder="empty"  // Default - no placeholder
/>
```

## Quality Settings

Control compression quality (1-100, default 75):

```tsx
<Image
  src="/photo.jpg"
  alt="Photo"
  width={800}
  height={600}
  quality={90}  // Higher quality, larger file
/>
```

## Object Fit and Position

Control how images fill their container:

```tsx
// Cover - fills container, may crop
<Image src="/photo.jpg" alt="" fill className="object-cover" />

// Contain - fits within container, may letterbox
<Image src="/photo.jpg" alt="" fill className="object-contain" />

// Custom position
<Image src="/photo.jpg" alt="" fill className="object-cover object-top" />
```

## Examples

### Basic Example: Profile Avatar

```tsx
import Image from 'next/image';

type AvatarProps = {
  src: string;
  name: string;
  size?: 'sm' | 'md' | 'lg';
};

export function Avatar({ src, name, size = 'md' }: AvatarProps) {
  const dimensions = { sm: 32, md: 48, lg: 64 };
  const dim = dimensions[size];

  return (
    <Image
      src={src}
      alt={`${name}'s avatar`}
      width={dim}
      height={dim}
      className="rounded-full"
    />
  );
}
```

### Normal Example: Image Gallery

```tsx
import Image from 'next/image';

type GalleryImage = {
  id: string;
  url: string;
  alt: string;
  blurDataURL?: string;
};

export function Gallery({ images }: { images: GalleryImage[] }) {
  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
      {images.map((image, index) => (
        <div key={image.id} className="relative aspect-square">
          <Image
            src={image.url}
            alt={image.alt}
            fill
            sizes="(max-width: 768px) 50vw, 33vw"
            className="object-cover rounded-lg"
            placeholder={image.blurDataURL ? 'blur' : 'empty'}
            blurDataURL={image.blurDataURL}
            priority={index < 6}  // Priority for first 6 images
          />
        </div>
      ))}
    </div>
  );
}
```

### Complex Example: Product Image with Zoom

```tsx
'use client';

import Image from 'next/image';
import { useState } from 'react';

type ProductImageProps = {
  images: { url: string; alt: string }[];
};

export function ProductImage({ images }: ProductImageProps) {
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [isZoomed, setIsZoomed] = useState(false);

  return (
    <div className="space-y-4">
      {/* Main Image */}
      <div
        className="relative aspect-square cursor-zoom-in overflow-hidden rounded-lg"
        onClick={() => setIsZoomed(true)}
      >
        <Image
          src={images[selectedIndex].url}
          alt={images[selectedIndex].alt}
          fill
          sizes="(max-width: 768px) 100vw, 50vw"
          className="object-cover"
          priority
        />
      </div>

      {/* Thumbnails */}
      <div className="flex gap-2">
        {images.map((image, index) => (
          <button
            key={index}
            onClick={() => setSelectedIndex(index)}
            className={`relative h-16 w-16 rounded border-2 ${
              index === selectedIndex ? 'border-blue-500' : 'border-transparent'
            }`}
          >
            <Image
              src={image.url}
              alt=""
              fill
              sizes="64px"
              className="object-cover rounded"
            />
          </button>
        ))}
      </div>

      {/* Zoom Modal */}
      {isZoomed && (
        <div
          className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
          onClick={() => setIsZoomed(false)}
        >
          <div className="relative w-full max-w-4xl aspect-square">
            <Image
              src={images[selectedIndex].url}
              alt={images[selectedIndex].alt}
              fill
              sizes="100vw"
              className="object-contain"
            />
          </div>
        </div>
      )}
    </div>
  );
}
```

## Performance Best Practices

1. **Use `priority` wisely** - Only for LCP images (hero, above-fold)
2. **Always set `sizes`** - Helps browser pick optimal image size
3. **Use appropriate quality** - 75 is good default, lower for thumbnails
4. **Prefer local imports** - Enables automatic blur placeholders
5. **Configure remote patterns** - Be specific with allowed domains

## Key Takeaways

- `next/image` automatically optimizes images (format, size, lazy loading)
- Use `fill` with `object-cover` for responsive images
- Set `priority` for above-the-fold images
- Always provide `sizes` when using `fill`
- Configure `remotePatterns` for external images
- Use blur placeholders for better perceived performance

## Questions & Answers

### Q: Why isn't my remote image loading?
**A:** Add the domain to `remotePatterns` in `next.config.ts`.

### Q: How do I handle user-uploaded images?
**A:** Use a CDN like Cloudinary or Vercel Blob, and add the domain to `remotePatterns`.

### Q: Can I use SVGs with next/image?
**A:** Yes, but they're served as-is without optimization. For icons, consider inline SVG or a component library.

### Q: How do I generate blur placeholders for remote images?
**A:** Use a library like `plaiceholder` at build time, or generate them when images are uploaded.

## Resources

- [Next.js: Image Component](https://nextjs.org/docs/app/api-reference/components/image)
- [Next.js: Image Optimization](https://nextjs.org/docs/app/building-your-application/optimizing/images)
- [Web.dev: Image Optimization](https://web.dev/fast/#optimize-your-images)

---

**Next:** [10.2 Fonts](./10.2-fonts.md) - Optimize fonts with next/font.
